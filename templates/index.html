<!DOCTYPE html>
<html>
<head>
    <title>MP4 ⇆ TXT Converter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<div class="container">
    <h1>Convert MP4 ⇆ TXT</h1>
    <form id="uploadForm" method="POST" enctype="multipart/form-data">
        <input type="file" name="file" required><br><br>
        <label><input type="radio" name="mode" value="encode" checked> MP4 ➝ TXT</label>
        <label><input type="radio" name="mode" value="decode"> TXT ➝ MP4</label>
        <br><br>
        <button type="submit">Convert</button>
    </form>

    <div class="progress-container">
        <div id="progress-bar"></div>
    </div>
    <p id="status"></p>
</div>

<script>
document.getElementById("uploadForm").onsubmit = function(e) {
    e.preventDefault();
    
    const fileInput = document.querySelector('input[type="file"]');
    const mode = document.querySelector('input[name="mode"]:checked').value;
    const file = fileInput.files[0];
    
    if (!file) {
        document.getElementById("status").innerText = "Please select a file!";
        return;
    }

    document.getElementById("status").innerText = "Processing file...";
    document.getElementById("progress-bar").style.width = "20%";

    const reader = new FileReader();
    
    reader.onload = function(e) {
        document.getElementById("progress-bar").style.width = "50%";
        document.getElementById("status").innerText = "Converting...";
        
        const fileData = e.target.result;
        const filename = file.name;
        
        // Send to server for processing
        fetch('/convert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                fileData: fileData,
                mode: mode,
                filename: filename
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById("progress-bar").style.width = "100%";
                document.getElementById("status").innerText = "Done! Download starting...";
                
                // Convert base64 to blob and download
                const byteCharacters = atob(data.data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mode === 'encode' ? 'text/plain' : 'video/mp4' });
                
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = data.filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            } else {
                document.getElementById("status").innerText = "Error: " + data.error;
            }
        })
        .catch(error => {
            document.getElementById("status").innerText = "Error: " + error.message;
        });
    };
    
    reader.onerror = function() {
        document.getElementById("status").innerText = "Error reading file!";
    };
    
    // Read file as base64
    reader.readAsDataURL(file);
};
</script>
</body>
</html>
